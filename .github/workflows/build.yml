name: Build

on:
  push:
    branches: [dev]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository and submodules
      - name: Checkout repository and submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      # 2. Cache JDK 21
      - name: Cache JDK 21
        uses: actions/cache@v3
        with:
          path: ~/.cache/sdkman
          key: ${{ runner.os }}-jdk-21-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-jdk-21-

      # 3. Setup JDK 21
      - name: Setup JDK 21 from Zulu OpenJDK
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '21'

      # 4. Grant execute permissions to Gradle wrapper
      - name: Grant permissions to Gradlew
        run: chmod +x ./gradlew

      # 5. Build the project
      - name: Setup and build
        run: ./gradlew build

      # 6. Upload build artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          path: build/libs/*.jar

      # 7. Install GitHub CLI
      - name: Install GitHub CLI
        run: sudo apt-get install gh -y

      # 8. Authenticate with GitHub CLI
      - name: Authenticate with GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # 9. Get the latest commit hash as TAG_NAME
      - name: Get commit hash
        id: commit_hash
        run: echo "TAG_NAME=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 10. Create Git tag
      - name: Create Git tag
        run: |
          git tag ${{ env.TAG_NAME }}
          git push origin ${{ env.TAG_NAME }}
          
          # 11. Create or update GitHub Release
          - name: Create or update GitHub release with commit message and README
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            run: |
              # Fetch all history for all tags and branches
              git fetch --all --tags
          
              # Get the latest commit message
              COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          
              # Calculate SHA-256 checksums for all .jar files
              CHECKSUMS=""
              for JAR in build/libs/*.jar; do
                SHA256=$(sha256sum "$JAR" | awk '{print $1}')
                CHECKSUMS+="- $JAR\n  - SHA-256: $SHA256\n"
              done
          
              # Get the build time from the latest commit
              BUILD_TIME=$(git log -1 --date=short --pretty=format:"%ad")
          
              # Use the environment variable for the tag name set in the previous step
              TAG_NAME=${{ env.TAG_NAME }}
          
              # Use a 'here document' to populate the release notes
              IFS='' read -r -d '' RELEASE_NOTES <<EOF
              ${COMMIT_MESSAGE}
          
              ### Checksums of Build Artifacts:
              ${CHECKSUMS}
          
              ### Build Information:
              Build Time: ${BUILD_TIME}
              EOF
          
              # Check if a release for this tag already exists
              if gh release view "$TAG_NAME" > /dev/null 2>&1; then
                # If the release exists, edit it and upload assets, overwriting any existing ones
                gh release upload "$TAG_NAME" build/libs/*.jar --clobber
                gh release edit "$TAG_NAME" \
                  --title "Automated Build - $TAG_NAME" \
                  --notes "$RELEASE_NOTES"
              else
                # If the release does not exist, create a new one
                gh release create "$TAG_NAME" build/libs/*.jar \
                  --title "Automated Build - $TAG_NAME" \
                  --notes "$RELEASE_NOTES"
              fi